# Git Hooks Setup for Quality Gates

## Overview

This document describes how to set up automated quality gates using Git hooks.

## Pre-commit Hook

The pre-commit hook runs before each commit to ensure code quality.

### Manual Setup (Without Husky)

1. Navigate to the `.git/hooks` directory in your project root
2. Create a file named `pre-commit` (no extension)
3. Add the following content:

```bash
#!/bin/sh
# Pre-commit hook for Taller Ocampos Frontend

echo "Running pre-commit checks..."

# Change to frontend directory
cd frontend

# Run type checking
echo "Type checking..."
npm run type-check
if [ $? -ne 0 ]; then
  echo "Type check failed. Please fix type errors before committing."
  exit 1
fi

# Run linting
echo "Linting..."
npm run lint
if [ $? -ne 0 ]; then
  echo "Linting failed. Please fix lint errors before committing."
  echo "Tip: Run 'npm run lint:fix' to auto-fix some issues."
  exit 1
fi

# Run unit tests
echo "Running unit tests..."
npm run test:unit -- --bail --findRelatedTests
if [ $? -ne 0 ]; then
  echo "Unit tests failed. Please fix failing tests before committing."
  exit 1
fi

echo "All pre-commit checks passed!"
exit 0
```

4. Make the hook executable:
   ```bash
   chmod +x .git/hooks/pre-commit
   ```

### Setup with Husky (Recommended)

If you want to use Husky for managing Git hooks:

1. Install Husky:
   ```bash
   npm install --save-dev husky
   ```

2. Initialize Husky:
   ```bash
   npx husky install
   ```

3. Add pre-commit hook:
   ```bash
   npx husky add .husky/pre-commit "cd frontend && npm run pre-commit"
   ```

4. Make Husky install automatic:
   ```bash
   npm set-script prepare "husky install"
   ```

## Pre-push Hook

The pre-push hook runs before pushing to ensure full quality gates pass.

### Manual Setup

Create `.git/hooks/pre-push`:

```bash
#!/bin/sh
# Pre-push hook for Taller Ocampos Frontend

echo "Running pre-push quality gates..."

cd frontend

# Run full quality gate
echo "Running quality gate (type-check, lint, tests, coverage)..."
npm run quality-gate
if [ $? -ne 0 ]; then
  echo "Quality gate failed. Please fix all issues before pushing."
  exit 1
fi

echo "All quality gates passed!"
exit 0
```

Make executable:
```bash
chmod +x .git/hooks/pre-push
```

### Setup with Husky

```bash
npx husky add .husky/pre-push "cd frontend && npm run quality-gate"
```

## Commit Message Hook

For enforcing conventional commit messages:

Create `.git/hooks/commit-msg`:

```bash
#!/bin/sh
# Commit message hook for conventional commits

commit_msg_file=$1
commit_msg=$(cat "$commit_msg_file")

# Conventional commit pattern
pattern="^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .{1,100}"

if ! echo "$commit_msg" | grep -qE "$pattern"; then
  echo "Invalid commit message format!"
  echo "Commit message must follow conventional commits format:"
  echo "  <type>(<scope>): <description>"
  echo ""
  echo "Types: feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert"
  echo ""
  echo "Examples:"
  echo "  feat(auth): add login functionality"
  echo "  fix(dashboard): resolve data loading issue"
  echo "  test(billing): add invoice payment tests"
  exit 1
fi

exit 0
```

Make executable:
```bash
chmod +x .git/hooks/commit-msg
```

## Bypassing Hooks (Emergency Only)

In rare cases where you need to bypass hooks:

```bash
git commit --no-verify -m "Emergency fix"
git push --no-verify
```

**Warning**: Only use `--no-verify` in genuine emergencies. Bypassing quality gates can introduce bugs into the codebase.

## Testing Hooks

Test pre-commit hook:
```bash
git commit --allow-empty -m "Test: trigger pre-commit hook"
```

Test pre-push hook:
```bash
git push --dry-run
```

## Troubleshooting

### Hook not executing
- Ensure hook file is executable: `chmod +x .git/hooks/<hook-name>`
- Check hook file has no extension
- Verify shebang line: `#!/bin/sh`

### Hook failing unexpectedly
- Run commands manually to debug: `cd frontend && npm run pre-commit`
- Check npm script definitions in `package.json`
- Verify all dependencies installed: `npm install`

### Windows compatibility
- Git Bash or WSL recommended for hook execution
- Alternatively, use Husky which handles cross-platform compatibility

## CI/CD Integration

These hooks complement the CI/CD pipeline defined in `.github/workflows/ci.yml`:

- **Pre-commit**: Fast local checks (type-check, lint, unit tests)
- **Pre-push**: Full quality gate (including coverage)
- **CI/CD**: Complete validation (unit, integration, E2E, build, security)

This layered approach ensures:
1. Immediate feedback during development
2. Comprehensive validation before code review
3. Full system verification before deployment
