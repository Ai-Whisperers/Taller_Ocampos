// PostgreSQL schema for production deployment
// Compatible with Vercel Postgres, Neon, Railway, Render

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// PostgreSQL native enums for type safety

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      String   @default("ADMIN") // ADMIN, MANAGER, TECHNICIAN, RECEPTIONIST
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workOrders  WorkOrder[]
  invoices    Invoice[]
  payments    Payment[]
  appointments Appointment[]
  estimates   Estimate[]
  activityLogs ActivityLog[]

  @@index([email])
  @@index([role])
}

model Client {
  id        String   @id @default(uuid())
  name      String
  email     String?  @unique
  phone     String
  address   String?
  taxId     String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  vehicles   Vehicle[]
  workOrders WorkOrder[]
  invoices   Invoice[]
  payments   Payment[]
  appointments Appointment[]
  estimates  Estimate[]

  @@index([email])
  @@index([name])
  @@index([phone])
}

model Vehicle {
  id           String   @id @default(uuid())
  clientId     String
  licensePlate String   @unique
  vin          String?  @unique
  brand        String
  model        String
  year         Int
  color        String?
  mileage      Int?
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  client       Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  workOrders   WorkOrder[]
  appointments Appointment[]
  estimates    Estimate[]
  maintenanceSchedules MaintenanceSchedule[]

  @@index([clientId])
  @@index([licensePlate])
  @@index([vin])
}

model WorkOrder {
  id               String          @id @default(uuid())
  orderNumber      String          @unique
  clientId         String
  vehicleId        String
  userId           String
  estimateId       String?
  status           String          @default("DRAFT") // DRAFT, PENDING_APPROVAL, APPROVED, IN_PROGRESS, WAITING_PARTS, READY_FOR_PICKUP, COMPLETED, CANCELLED
  description      String
  diagnostics      String?
  estimatedHours   Float?
  actualHours      Float?
  laborRate        Float
  estimatedCost    Float?
  actualCost       Float?
  startDate        DateTime?
  completionDate   DateTime?
  notes            String?
  internalNotes    String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  client       Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  vehicle      Vehicle             @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  user         User                @relation(fields: [userId], references: [id])
  estimate     Estimate?           @relation(fields: [estimateId], references: [id])
  services     WorkOrderService[]
  parts        WorkOrderPart[]
  invoices     Invoice[]
  attachments  Attachment[]

  @@index([orderNumber])
  @@index([clientId])
  @@index([vehicleId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model ServiceCategory {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  services Service[]

  @@index([name])
}

model Service {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  description String?
  categoryId  String?
  basePrice   Float
  estimatedHours Float?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category      ServiceCategory?  @relation(fields: [categoryId], references: [id])
  workOrderServices WorkOrderService[]
  estimateServices  EstimateService[]

  @@index([code])
  @@index([categoryId])
  @@index([isActive])
}

model WorkOrderService {
  id          String   @id @default(uuid())
  workOrderId String
  serviceId   String
  quantity    Int      @default(1)
  unitPrice   Float
  discount    Float?
  total       Float
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  service   Service   @relation(fields: [serviceId], references: [id])

  @@index([workOrderId])
  @@index([serviceId])
}

model Part {
  id           String   @id @default(uuid())
  code         String   @unique
  name         String
  description  String?
  category     String?
  brand        String?
  costPrice    Float
  salePrice    Float
  currentStock Int      @default(0)
  minStock     Int      @default(0)
  maxStock     Int?
  location     String?
  supplierId   String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  supplier       Supplier?       @relation(fields: [supplierId], references: [id])
  workOrderParts WorkOrderPart[]
  estimateParts  EstimatePart[]
  stockMovements StockMovement[]

  @@index([code])
  @@index([category])
  @@index([supplierId])
  @@index([isActive])
  @@index([currentStock])
}

model WorkOrderPart {
  id          String   @id @default(uuid())
  workOrderId String
  partId      String
  quantity    Int
  unitPrice   Float
  discount    Float?
  total       Float
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  part      Part      @relation(fields: [partId], references: [id])

  @@index([workOrderId])
  @@index([partId])
}

model Supplier {
  id        String   @id @default(uuid())
  name      String
  taxId     String?
  email     String?
  phone     String?
  address   String?
  website   String?
  notes     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  parts Part[]

  @@index([name])
  @@index([isActive])
}

model Invoice {
  id            String        @id @default(uuid())
  invoiceNumber String        @unique
  workOrderId   String?
  clientId      String
  userId        String
  status        String        @default("DRAFT") // DRAFT, SENT, PAID, PARTIALLY_PAID, OVERDUE, CANCELLED
  issueDate     DateTime      @default(now())
  dueDate       DateTime
  subtotal      Float
  taxRate       Float
  taxAmount     Float
  discount      Float?
  total         Float
  paidAmount    Float         @default(0)
  notes         String?
  terms         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  workOrder  WorkOrder? @relation(fields: [workOrderId], references: [id])
  client     Client     @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id])
  payments   Payment[]

  @@index([invoiceNumber])
  @@index([clientId])
  @@index([userId])
  @@index([status])
  @@index([dueDate])
  @@index([createdAt])
}

model Payment {
  id            String        @id @default(uuid())
  paymentNumber String        @unique
  invoiceId     String
  clientId      String
  userId        String
  amount        Float
  method        String        // CASH, CREDIT_CARD, DEBIT_CARD, BANK_TRANSFER, CHECK, OTHER
  reference     String?
  notes         String?
  paymentDate   DateTime      @default(now())
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  client  Client  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id])

  @@index([paymentNumber])
  @@index([invoiceId])
  @@index([clientId])
  @@index([paymentDate])
  @@index([method])
}

model StockMovement {
  id           String   @id @default(uuid())
  partId       String
  type         String   // IN, OUT, ADJUSTMENT, RETURN
  quantity     Int
  previousStock Int
  currentStock Int
  reference    String?
  notes        String?
  createdAt    DateTime @default(now())

  part Part @relation(fields: [partId], references: [id], onDelete: Cascade)

  @@index([partId])
  @@index([type])
  @@index([createdAt])
}

model Attachment {
  id          String   @id @default(uuid())
  workOrderId String
  fileName    String
  fileUrl     String
  fileType    String
  fileSize    Int
  uploadedBy  String
  createdAt   DateTime @default(now())

  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@index([createdAt])
}

// New Models for Enhanced Functionality

model Appointment {
  id          String   @id @default(uuid())
  appointmentNumber String @unique
  clientId    String
  vehicleId   String
  userId      String
  status      String   @default("SCHEDULED") // SCHEDULED, CONFIRMED, IN_PROGRESS, COMPLETED, CANCELLED, NO_SHOW
  scheduledDate DateTime
  duration    Int      // in minutes
  serviceType String
  description String?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  client  Client  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id])

  @@index([appointmentNumber])
  @@index([clientId])
  @@index([vehicleId])
  @@index([scheduledDate])
  @@index([status])
}

model Estimate {
  id            String   @id @default(uuid())
  estimateNumber String  @unique
  clientId      String
  vehicleId     String
  userId        String
  status        String   @default("DRAFT") // DRAFT, SENT, APPROVED, REJECTED, EXPIRED
  description   String
  diagnostics   String?
  validUntil    DateTime
  subtotal      Float
  taxRate       Float
  taxAmount     Float
  total         Float
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  client   Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  vehicle  Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id])
  services EstimateService[]
  parts    EstimatePart[]
  workOrders WorkOrder[]

  @@index([estimateNumber])
  @@index([clientId])
  @@index([vehicleId])
  @@index([status])
  @@index([validUntil])
}

model EstimateService {
  id         String  @id @default(uuid())
  estimateId String
  serviceId  String
  quantity   Int     @default(1)
  unitPrice  Float
  total      Float
  notes      String?
  createdAt  DateTime @default(now())

  estimate Estimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)
  service  Service  @relation(fields: [serviceId], references: [id])

  @@index([estimateId])
  @@index([serviceId])
}

model EstimatePart {
  id         String  @id @default(uuid())
  estimateId String
  partId     String
  quantity   Int
  unitPrice  Float
  total      Float
  notes      String?
  createdAt  DateTime @default(now())

  estimate Estimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)
  part     Part     @relation(fields: [partId], references: [id])

  @@index([estimateId])
  @@index([partId])
}

model MaintenanceSchedule {
  id              String   @id @default(uuid())
  vehicleId       String
  serviceName     String
  description     String?
  intervalMiles   Int?
  intervalMonths  Int?
  lastServiceDate DateTime?
  lastServiceMileage Int?
  nextServiceDate DateTime?
  nextServiceMileage Int?
  isActive        Boolean  @default(true)
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@index([nextServiceDate])
  @@index([isActive])
}

model ActivityLog {
  id          String   @id @default(uuid())
  userId      String
  action      String
  entityType  String
  entityId    String
  description String
  metadata    String?  // JSON string for additional data
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType])
  @@index([entityId])
  @@index([createdAt])
  @@index([action])
}